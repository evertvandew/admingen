#!/usr/bin/env python3
"""
Take a XML-server definition, and take out the Page tags, add some HTML overhead and
write them to the file system as static pages.
"""


# TODO: Create directories for the data tables

from admingen.xml_template import processor, Tag, Template
import os, os.path
import sys
import json


page_template = Template("""<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>${title}</title>
    ${headers}
    <link rel="stylesheet" type="text/css" href="/batic/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="/batic/css/fontawesome.min.css" />
    <link rel="stylesheet" type="text/css" href="/batic/css/solid.min.css" />
    <script src="/batic/js/jquery-3.5.1.min.js"></script>
    <script src="/batic/js/bootstrap.min.js"></script>


</head>
<body style="margin-top:0px">
<div id="ackDelete" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bevestig verwijderen</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Weet je het zeker?</p>
      </div>
      <div class="modal-footer">
        <button id="ackDeleteYes" type="button" class="btn btn-primary">Yes</button>
        <button id="ackDeleteNo" type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
      </div>
    </div>
  </div>
</div>
<script>
    function acm_authorized(required) {
        return true;
    }
</script>
${heading}
${lines}
${footer}
</body>
</html>""")


created_pages = []
acm = {}
current_page_context = dict(headers='', title='admingen', heading='', footer='', acm='user,editor,administrator')


def handle_Page(args, lines):
    """ Handle a page definition by writing the HTML inside it to file. """
    url = args['url']
    assert ':' not in url
    if url in created_pages:
        raise RuntimeError('Creating page', url, 'for the second time')
    text = page_template.render(lines=lines, **current_page_context)
    dirname, fname = os.path.split('html/'+url.strip('/'))
    print ('Writing:', dirname, fname)
    if not os.path.exists(dirname):
        os.makedirs(dirname)
    with open(os.path.join(dirname, fname), 'w') as out:
        out.write(text)
    
    # Also determine the ACM parameters
    acm[url.strip('/')] = args.get('acm', current_page_context['acm'])
    return ''


def handle_PageContextValue(args, lines):
    """ Let the user modify a value in the page context.
        This value is used for all subsequent pages.
    """
    assert 'name' in args
    current_page_context[args['name']] = lines
    return ''

if False:
    os.chdir('/home/ehwaal/projects/sab')
    processor({'Page': Tag('Page', handle_Page),
               'PageContextValue': Tag('PageContextValue', handle_PageContextValue)},
              open('page_definitions.xml'))
else:
    processor({'Page': Tag('Page', handle_Page),
               'PageContextValue': Tag('PageContextValue', handle_PageContextValue)},
              sys.stdin)
    # Also update the ACM table
    with open('acm_table.json', 'w') as out:
        json.dump(acm, out)
