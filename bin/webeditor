#!/usr/bin/env python3
""" Generate a webinterface for editing a data file.

Also opens a default webbrowser that loads the edit page.
"""


import argparse
import os, os.path
import sys

from admingen.htmltools import *
from admingen.data import CsvReader, CsvWriter


tmpdir = '/run/user/%s/webedit/'%os.getuid()
if not os.path.exists(tmpdir):
    os.mkdir(tmpdir, 0o700)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('file', help='The file to be edited')
    args = parser.parse_args()

    # Check the file exists
    if not os.path.exists(args.file):
        print("File does not exist: %s"%args.file, file=sys.stderr)
        sys.exit(1)

    # Try to read the file
    data = CsvReader(open(args.file))
    basename = os.path.basename(args.file)
    buffername = tmpdir+basename

    # Create an in-RAM copy for buffering web edits
    CsvWriter(open(buffername, 'w'), data)


    runServer(dictCrudServer(data, Page()))
