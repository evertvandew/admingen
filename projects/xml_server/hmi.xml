<?xml version="1.0"?>

<!-- Use me as follows:
        ~/admingen/bin/xml_template -i hmi.xml |/admingen/bin/page_writer
        webfs.py --root-path html
-->

<Datamodel name="giftenoverzicht">
table: Organisation
    name: str, required, unique
    description: longstr
    mailfrom: email
    gift_accounts: str
    consolidated: bool, default=1
    template: longstr
    mail_body: longstr
    exact_division: int, required, unique
    admin_id: int
    logo: ImagePath
    status: int, default=1
    period_start: datetime
    perdiod_end: datetime
table: User
    name: str, required, unique
    fullname: str
    password: password, required
    role: str, required
    email: email
</Datamodel>


<Template tag="LargeButton" args="url">
    <A HREF="${url}" class="btn btn-large">${lines}</A>
</Template>

<Template tag="SmartTable" args="header,data=[],tid">

    <%
    header = eval(pageargs['header'])
    %>
    <table ${'id="%s"'%id if id else ''} class="table table-hover table-bordered">
        % if header:
            <thead><tr>
                % for h in header:
                    <th>${h}</th>
                % endfor
            </tr></thead>
        % endif
        % for line in data:
            <tr>
                % for part in line:
                    <td>${part}</td>
                % endfor
            </tr>
        % endfor
    </table>
</Template>

<Template tag="Form" args="submit='/data/login'">
    <form>
        ${lines}
        <input type="submit" value="${submit}" />
    </form>
</Template>

<Template tag="Field" args="name,text,type='text',id">
    <label>${text} <input name="${name}" type="${type}" /></label>
</Template>

<Template tag="AutoField" args="datafield,id">
    <%
        input_types = ['str', 'email', 'password', 'bool', 'date', 'datetime',
                       'int']

        source, table, column = datafield.split('.')
        dataitem = datamodels[source][table][column]
        coltype = dataitem[0]
        details = {k.split('=')[0]: (k.split('=', maxsplit=1)[1] if '=' in k else None) 
                for k in dataitem[1:]}
        name = ".".join([source, table, column])
        if coltype in input_types:
            translator = {'str': 'text', 'int': 'number', 'bool': 'checkbox'}
            inputtype = translator.get(coltype, coltype)
    %>
    <div class="form-group">
        <label class="col col-md-3 control-label">${column}</label>
        <div class="col col-md-9">
          % if coltype in input_types:
            <input type="${inputtype}" name="${name}" />
          % elif coltype == 'longstr':
            <textarea name="${name}" ></textarea>
          % else:
                Column type ${coltype} is not supported
          % endif
        </div>
    </div>
</Template>

<Template tag="AutoForm" args="datasource">
    <% 
        source, table = datasource.split('.')
        table_data = datamodels[source][table]
        column_paths = ['%s.%s'%(datasource, col) for col in table_data.keys()]
    %>
      <div id="div_${datasource}" class="container">
        <div class="row">
          <div class="col col-md-12">
            <form id="form_${datasource}" action="{action}" method="post" enctype="{enctype}" class="form-horizontal">
              % for column in column_paths:
                <AutoField datafield="${column}" />
              % endfor
            </form>
          </div>
        </div>
      </div>
</Template>


<Template tag="AutoEditor" args="datasource,url">
    <!-- We need several pages: an overview, a details view, a details edit and a delete page. -->
    <% 
        source, table = datasource.split('.')
        table_data = datamodels[source][table]
        column_paths = ['%s.%s'%(datasource, col) for col in table_data.keys()]
    %>
    <Page url="${url}/index.html">
        <script>
        /* Get the listing of the resource */
        $( document ).ready(function() {
            $.get("/data/${table}", function(data) {
                /* Update the list showing the all elements in the resource. */
                var table = $( "table[id|='${url}']" )[0]
                Object.keys(data).forEach(function(key,index) {
                    var line = data[key];
                    var row = table.insertRow(-1);
                    % for col in table_data.keys():
                        var cell = row.insertCell(-1);
                        cell.innerHTML = line.${col};
                    % endfor
                    var cell = row.insertCell(-1);
                    cell.innerHTML = '<i class="fa fa-times" />';
                    cell.onclick = function() {
                        location.href='${url}/delete?id='+key;
                        event.stopPropagation()
                    };
                    row.onclick = function() {
                        location.href='${url}/edit?id='+key;
                    };
                });
            }, "json");

        });
        </script>
        <SmartTable id="${url}" header="${list(table_data.keys())}"/>

        <LargeButton url="edit">Toevoegen <i class="fa fa-plus"></i></LargeButton>
    </Page>
    <Page url="${url}/view">
        ${lines}
    </Page>
    <Page url="${url}/edit">
        <script>
            $( document ).ready(function() {
                <!-- if relevant, get & fill values from the resource. -->
                const urlParams = new URLSearchParams(window.location.search);
                const myId = urlParams.get('id');
                if (myId) {
                    /* Get the current values using an Ajax call */
                    $.get("/data/${table}/"+myId, function(data) {
                        Object.keys(data).forEach(function(key,index) {
                            var value = data[key];
                            $( "*[name|='${datasource}."+key+"']" ).val(value);
                        });
                    }, "json");
                }
                <!-- Gather and save the data when click on the button -->
                $( "#confirm" ).on("click", function() {
                    var data = {};
                    var value;
                    % for key in table_data.keys():
                        value = $( "*[name|='${datasource + '.' + key}']" ).val();
                        data["${key}"] = value;
                    % endfor
                    if (!myId) {
                        $.post("/data/${table}", data);
                    } else {
                        $.post("/data/${table}/"+myId, data);
                    }
                });
            });
        </script>
        <AutoForm datasource="${datasource}" />
        <div class="col col-md-9 col-md-offset-3">
            <div id="confirm" class="btn btn-large" >Opslaan <i class="fa fa-save"></i></div>
        </div>

        ${lines}
    </Page>
    <Page url="${url}/delete">
        <script>
            <!-- Create a custom handler for the Delete button. -->
            $( document ).ready(function() {
                const urlParams = new URLSearchParams(window.location.search);
                const myId = urlParams.get('id');
                var url = "/data/${table}/"+myId;
                $( "#confirm" ).on("click", function() {
                    $.ajax({
                        type: "DELETE",
                        url: url,
                        success: function(){
                            location.href="${url}";
                        },
                        });
                    event.stopPropagation();
                });
            });
            
        </script>
        <div>Delete the record?
            <LargeButton url="${url}" >Cancel </LargeButton>
            <div id="confirm" class="btn btn-large">Delete </div>
        </div>
        ${lines}
    </Page>
</Template>


<PageContextValue name="header">
    <div>Hier komt het main work-flow menu...</div>
</PageContextValue>



<Acm redirect="login" variable_name="user">
<Page url="index.html">

# Welkom bij de beheerinterface van de Giftenoverzicht generator

<LargeButton url="/manage_organisation">Beheer Organisaties</LargeButton>
<LargeButton url="/manage_users" auth="admin">Beheer Gebruikers</LargeButton>

</Page>

<Page url="user2">
    <AutoForm datasource="giftenoverzicht.User"/>
</Page>

<PageContextValue name="header">
    <div>Hier komt het beheer menu...</div>
</PageContextValue>

<AutoEditor url="/manage_users" datasource="giftenoverzicht.User" />
<AutoEditor url="/manage_organisation" datasource="giftenoverzicht.Organisation" />


<Page url="login.html">
## Please login to use the website
<Form submit="/data/login">
<Field name="username" text="Gebuikersnaam" />
<Field name="password" text="Paswoord" type="password" />
</Form>
</Page>
